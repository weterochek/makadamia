let cart = {};
let productMap = {};

async function loadProductMap() {
    try {
        const response = await fetch('/products'); // Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¾Ñ‚Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð²ÑÐµ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹
        const products = await response.json();
        window.productMap = {}; // Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾
        products.forEach(product => {
            window.productMap[product._id] = {
                name: product.name,
                price: product.price
            };
        });
        console.log('âœ… ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹');
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð²:', error);
    }
}


// Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹ Ð¸Ð· localStorage

// Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹ Ð² localStorage
function saveCartToLocalStorage() {
    const cart = JSON.parse(localStorage.getItem('cartItems')) || [];
    localStorage.setItem('cartItems', JSON.stringify(cart));
}


// ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹
function renderCheckoutCart() {
    const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
    const cartItemsContainer = document.getElementById('cartItems');
    const totalAmountElement = document.getElementById('totalAmount');
    cartItemsContainer.innerHTML = '';

    let total = 0;

    cartItems.forEach(item => {
        const product = window.productMap[item.productId];
        if (product) {
            const itemTotal = product.price * item.quantity;
            total += itemTotal;

            const itemElement = document.createElement('div');
            itemElement.innerHTML = `
                <p>${product.name} x ${item.quantity} â€” ${itemTotal} â‚½</p>
            `;
            cartItemsContainer.appendChild(itemElement);
        }
    });

    totalAmountElement.textContent = `Ð˜Ñ‚Ð¾Ð³Ð¾: ${total} â‚½`;
}




// Ð£Ð¼ÐµÐ½ÑŒÑˆÐµÐ½Ð¸Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ñ‚Ð¾Ð²Ð°Ñ€Ð°
function incrementItem(productId) {
    let cart = JSON.parse(localStorage.getItem('cartItems')) || [];
    const item = cart.find(item => item.productId === productId);
    if (item) {
        item.quantity += 1;
    }
    localStorage.setItem('cartItems', JSON.stringify(cart));
    renderCart();
}

function decrementItem(productId) {
    let cart = JSON.parse(localStorage.getItem('cartItems')) || [];
    const index = cart.findIndex(item => item.productId === productId);
    if (index !== -1) {
        cart[index].quantity -= 1;
        if (cart[index].quantity === 0) {
            cart.splice(index, 1);
        }
    }
    localStorage.setItem('cartItems', JSON.stringify(cart));
    renderCart();
}

// Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
async function loadUserData() {
    try {
        const response = await fetch('/api/account', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
            }
        });
        if (response.ok) {
            const userData = await response.json();
            document.getElementById('name').value = userData.username || '';
            document.getElementById('address').value = userData.address || '';
        } else {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ');
        }
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', error);
    }
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°
document.addEventListener("DOMContentLoaded", async () => {
    await loadProductMap(); // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹
    renderCheckoutCart();   // Ð ÐµÐ½Ð´ÐµÑ€Ð¸Ð¼ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ
    loadUserData(); // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ

    const backToShoppingButton = document.getElementById("backToShopping");
    if (backToShoppingButton) {
        backToShoppingButton.addEventListener("click", () => {
            saveCartToLocalStorage();
            window.location.href = "index.html";
        });
    }

    const checkoutForm = document.getElementById("checkoutForm");
    if (checkoutForm) {
        checkoutForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            const token = localStorage.getItem("accessToken");

            if (!token) {
                alert("Ð’Ñ‹ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ‹!");
                return;
            }

            const storedCart = JSON.parse(localStorage.getItem('cartItems')) || [];
            const items = storedCart.map(item => ({
                productId: item.productId,
                quantity: item.quantity
            }));

            const nameInput = document.getElementById('customerName');
            const addressInput = document.getElementById('customerAddress');
            const additionalInfoInput = document.getElementById('additionalInfo');
            const userId = localStorage.getItem("userId");

            const orderData = {
                userId: userId,
                name: nameInput.value,
                address: addressInput.value,
                additionalInfo: additionalInfoInput.value,
                items: items
            };

            console.log("ðŸ“¡ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð°ÐºÐ°Ð·Ð°:", orderData);

            try {
                const response = await fetch("https://makadamia.onrender.com/api/order", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(orderData)
                });

                console.log("ðŸ“¥ ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°:", response);

                if (!response.ok) {
                    console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ${response.status}:`, response.statusText);
                    alert("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°.");
                    return;
                }

                const responseData = await response.json();
                console.log("âœ… Ð—Ð°ÐºÐ°Ð· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½:", responseData);

                alert("ðŸŽ‰ Ð—Ð°ÐºÐ°Ð· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½!");
                localStorage.removeItem('cartItems');
                window.location.href = "index.html";
            } catch (error) {
                console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸ Ð¸Ð»Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°:", error);
                alert("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ.");
            }
        });
    }
}); //
function loadCartFromLocalStorage() {
    const orderSummary = document.getElementById('orderSummary');
    if (!orderSummary) return;
    orderSummary.innerHTML = '';

    let totalAmount = 0;

    // âœ… Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ Ð¿Ð°Ñ€ÑÐ¸Ð¼ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ:
    let cart = [];
    const cartRaw = localStorage.getItem('cartItems');
    try {
        if (cartRaw && cartRaw !== 'undefined') {
            cart = JSON.parse(cartRaw);
        }
    } catch (e) {
        console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° cartItems Ð² loadCartFromLocalStorage:", e);
        cart = [];
    }

    cart.forEach(item => {
        const product = productMap[item.productId];
        if (!product) return;

        const itemTotal = product.price * item.quantity;
        totalAmount += itemTotal;

        const orderItem = document.createElement('div');
        orderItem.innerHTML = `${product.name} - ${item.quantity} ÑˆÑ‚. - ${itemTotal} â‚½`;
        orderSummary.appendChild(orderItem);
    });

    const totalOrderAmount = document.getElementById('totalOrderAmount');
    if (totalOrderAmount) {
        totalOrderAmount.textContent = totalAmount + ' â‚½';
    }
}

            // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ


